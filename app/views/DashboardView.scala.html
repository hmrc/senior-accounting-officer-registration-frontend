@*
 * Copyright 2025 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@this(
  layout: templates.Layout,
  govukButton: GovukButton,
  formHelper: FormWithCSRF
)

@(givenState: DashboardState)(implicit request: Request[_], messages: Messages)

@rowStatus(progress: Int, rowIndex: Int): Int = @{
  if (progress == 3) 2                    // all done -> every row completed
  else if (rowIndex < progress) 2         // completed
  else if (rowIndex == progress) 1        // in progress (clickable)
  else 0                                  // cannot start yet
}

@isClickable(state: Int): Boolean = @{ state == 1 }

@statusKey(state: Int): String = @{
  state match {
    case 0 => "registration.dashboard.cannotStartYet"
    case 1 => "registration.dashboard.notStarted"
    case 2 => "registration.dashboard.completed"
    case _ => "registration.dashboard.completed"
  }
}

@statusTagClass(state: Int): Option[String] = @{
  state match {
    case 1 => Some("govuk-tag govuk-tag--blue")
    case 2 => Some("govuk-tag govuk-tag--green")
    case _ => None
  }
}

@statusId(rowIndex: Int) = @{ s"registration-details-$rowIndex-status" }

@createRowLink(rowIndex: Int, progress: Int, rowLabel: String, linkHref: String) = {
  @defining(rowStatus(progress, rowIndex)) { state =>
  @defining(statusId(rowIndex)) { id =>
    <li class="govuk-task-list__item @if(isClickable(state)) {govuk-task-list__item--with-link}">
      <div class="govuk-task-list__name-and-hint">
        @if(isClickable(state)) {
          <a class="govuk-link govuk-task-list__link"
             href="@linkHref"
             aria-describedby="@id">
            @rowLabel
          </a>
        } else {
          @rowLabel
        }
      </div>

      <div class="govuk-task-list__status" id="@id">
        @statusTagClass(state).map { cls =>
          <strong class="@cls">
            @messages(statusKey(state))
          </strong>
        }.getOrElse {
          @messages(statusKey(state))
        }
      </div>
    </li>
  }}
}

@layout(showBackLink = false, pageTitle = titleNoForm(messages("registration.dashboard.title"))) {
    <h1 class="govuk-heading-l">@messages("registration.dashboard.heading")</h1>
    <p class="govuk-body">@messages("registration.dashboard.p1")</p>
    <p class="govuk-body">@messages("registration.dashboard.p2")</p>

  <ul class="govuk-task-list">
    @createRowLink(
      rowIndex = 0,
      progress = givenState.ordinal,
      rowLabel = messages("registration.dashboard.row.label.company"),
      linkHref = routes.GrsController.start().url
    )

    @createRowLink(
      rowIndex = 1,
      progress = givenState.ordinal,
      rowLabel = messages("registration.dashboard.row.label.contacts"),
      linkHref = routes.ContactDetailsGuidanceController.onPageLoad().url
    )

    @createRowLink(
      rowIndex = 2,
      progress = givenState.ordinal,
      rowLabel = messages("registration.dashboard.row.label.submit"),
      linkHref = routes.CheckYourAnswersController.onPageLoad().url
    )
  </ul>

  <p class="govuk-body">@messages("registration.dashboard.p3")</p>
}

